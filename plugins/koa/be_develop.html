<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>后端插件开发 | Lin CMS</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/lin-cms-doc/favicon.ico">
    <meta name="description" content="">
    <link rel="preload" href="/lin-cms-doc/assets/css/0.styles.1baad530.css" as="style"><link rel="preload" href="/lin-cms-doc/assets/js/app.569b92f7.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/9.dfe2ee52.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/2.9a39114c.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/47.7ebbd042.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/4.8535a4ee.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/6.a174ce70.js" as="script"><link rel="preload" href="/lin-cms-doc/assets/js/5.1de948cb.js" as="script"><link rel="prefetch" href="/lin-cms-doc/assets/js/10.c0b28b86.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/100.a6901e21.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/101.fd68e6ef.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/102.ff8160f8.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/103.5701f1b5.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/104.55490870.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/105.3ee763b7.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/11.289272d6.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/12.1dfe5b97.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/13.45afe355.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/14.989b39d3.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/15.ba0a8d06.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/16.bb225960.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/17.8f1de43d.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/18.cdb89759.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/19.f427e1c4.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/20.1924c022.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/21.2a061dcf.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/22.bbe6380c.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/23.8417491e.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/24.b0c5e9e5.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/25.d9fcb4d9.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/26.9e93a8d6.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/27.57534ca7.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/28.bcd62b45.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/29.7c5b1886.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/3.56f8fd96.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/30.4f379f3f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/31.08544b9f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/32.7422c933.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/33.69a7640c.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/34.ae12b601.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/35.586cc372.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/36.b03135b1.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/37.1ac1f3d8.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/38.13ceb882.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/39.68f3508f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/40.383d13c7.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/41.7b5177b3.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/42.707e8921.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/43.bf4a65f8.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/44.9abbce1f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/45.ce57b142.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/46.62b94e1d.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/48.2f4cc569.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/49.42c54594.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/50.40340c9f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/51.f2cf9dfe.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/52.52c179a5.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/53.045424e5.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/54.d3cee68b.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/55.925c004a.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/56.298d1c63.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/57.24e048cb.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/58.be33373a.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/59.829a7b3c.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/60.b1e77986.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/61.bf190430.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/62.5c3a7050.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/63.f3800136.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/64.08d16290.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/65.cae010f2.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/66.363aab04.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/67.b3b34e59.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/68.5e91ba2d.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/69.4807d3ab.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/7.37917e82.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/70.2bb2bf43.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/71.613e847d.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/72.8b488136.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/73.cdfcd362.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/74.4b4793cc.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/75.e0c69a58.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/76.77774abf.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/77.175a08f1.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/78.d31b4a2a.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/79.78b7b264.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/8.b34c4351.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/80.04fb1385.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/81.d63dcc4c.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/82.8dff4683.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/83.5ef969ec.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/84.453f09ff.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/85.8cb2b4f8.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/86.7bfbc4b3.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/87.55b8975b.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/88.7b88cada.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/89.371efc9e.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/90.9f7df7ef.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/91.9eb85e89.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/92.0a5daea2.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/93.4bc9b80c.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/94.d61f961e.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/95.79c62d5f.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/96.244f0077.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/97.3c4753aa.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/98.50a1854a.js"><link rel="prefetch" href="/lin-cms-doc/assets/js/99.7252ac71.js">
    <link rel="stylesheet" href="/lin-cms-doc/assets/css/0.styles.1baad530.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lin-cms-doc/" class="home-link router-link-active"><img src="/lin-cms-doc/left-logo.png" alt="Lin CMS" class="logo"> <span class="site-name can-hide">Lin CMS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lin-cms-doc/" class="nav-link">
  介绍
</a></div><div class="nav-item"><a href="/lin-cms-doc/imooc/" class="nav-link">
  慕课课程
</a></div><div class="nav-item"><a href="/lin-cms-doc/start/" class="nav-link">
  入门
</a></div><div class="nav-item"><a href="/lin-cms-doc/server/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/lin-cms-doc/client/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/lin-cms-doc/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/lin-cms-doc/plugins/flask/" class="nav-link">
  插件
</a></div><div class="nav-item"><a href="/lin-cms-doc/update/" class="nav-link">
  版本日志
</a></div><div class="nav-item"><a href="https://course.7yue.pro/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  专栏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/TaleLin-cms-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/TaleLin/lin-cms-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lin-cms-doc/" class="nav-link">
  介绍
</a></div><div class="nav-item"><a href="/lin-cms-doc/imooc/" class="nav-link">
  慕课课程
</a></div><div class="nav-item"><a href="/lin-cms-doc/start/" class="nav-link">
  入门
</a></div><div class="nav-item"><a href="/lin-cms-doc/server/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/lin-cms-doc/client/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/lin-cms-doc/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/lin-cms-doc/plugins/flask/" class="nav-link">
  插件
</a></div><div class="nav-item"><a href="/lin-cms-doc/update/" class="nav-link">
  版本日志
</a></div><div class="nav-item"><a href="https://course.7yue.pro/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  专栏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/TaleLin-cms-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/TaleLin/lin-cms-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>插件koa版</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/lin-cms-doc/plugins/koa/" aria-current="page" class="sidebar-link">插件入门</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>插件flask版</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="敬请期待"><a href="#敬请期待" class="header-anchor">#</a> <div style="display:inline-block;" data-v-2fb52f6a><img src="" alt data-v-2fb52f6a></div> 敬请期待...</h1> <h1 id="深入学习插件机制"><a href="#深入学习插件机制" class="header-anchor">#</a> 深入学习插件机制</h1> <blockquote><p>本小节让我们来详细介绍一下 Lin 的精髓——插件机制</p></blockquote> <h2 id="插件的规范"><a href="#插件的规范" class="header-anchor">#</a> 插件的规范</h2> <p>首先，我们通过<a href="/lin-cms-doc/plugins/koa/fe.html">插件使用</a>一章中的<code>古诗词</code>插件示例 来看看插件的目录规范和
开发规范。</p> <h3 id="目录规范"><a href="#目录规范" class="header-anchor">#</a> 目录规范</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>├───poem
│   │   config.py  // 配置文件（必需），记录关于插件的可用配置
│   │   info.py    // 插件基本信息
│   │   README.md  // 插件文档
│   │   requirements.txt // 插件依赖包
│   │
│   └───app     // 应用开发目录
│           controller.py  // 控制层文件
│           forms.py       // 校验层文件
│           model.py       // 模型层文件
│           __init__.py    // 导出文件（必需）。重要！！！
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>app/plugins/poem
├── app
│   ├── controller.js
│   ├── index.js
│   ├── model.js
│   └── validators.js
└── config.js
</code></pre></div><p>Lin 的插件可能与你以前了解的插件概念不一样，<em>你可以把每个插件理解为一个小 app</em>。
每个插件都有自己的配置、控制层、模型层甚至校验层（forms），换言之每个插件都有自
己的业务，它的功能很像<strong>微服务</strong>，即每个插件只负责完成某一项功能。</p> <p>下面我们来介绍插件目录结构中的几个关键文件，你可以打开本地已经安装好的 <code>poem</code> 插
件的源码，对照学习</p> <ul><li><p><strong>config.py</strong><br>
配置文件，其中的所有配置项会在我们执行 <code>python plugin_init.py</code> 初始化插件成功
后，自动写入到项目配置文件 <code>setting.py</code> 中，你也可以根据自己的业务场景自由修改
配置项，关于配置文件的更多话题，我们在下面会继续介绍。</p></li> <li><p>关于 <strong>info.py</strong><br>
插件基本信息，里面定义了三个变量<code>__name__</code>、<code>__version__</code>和<code>__author__</code>，分别
表示插件名、插件版本号和插件开发者。在插件初始化时，插件初始化脚本会根据
<code>info.py</code> 中的信息来找到对应的插件。</p></li> <li><p>关于 <strong>requirements.txt</strong><br>
如果你是在插件中使用了一些第三方库，这些库在主应用中是没有的，那么请你将它添加
到 <strong>requirements.txt</strong> 中。以方便我们运行初始化插件脚本的时候自动检测并安装这
些依赖。<strong>注意，在你自己开发插件的时候，请一定不要将主应用中已经存在的第三方库
添加到该文件中，否则可能造成插件与主应用的版本冲突，无法使用插件甚至主应用都会
因此受损！</strong> 文件的格式如下</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>oss2==2.6.1
</code></pre></div><h3 id="开发规范"><a href="#开发规范" class="header-anchor">#</a> 开发规范</h3> <p>如果你想开发一个插件，你可以使用项目中的 <code>verdor/plugin_generator.py</code> 脚本来生成
一个后端插件的基础模板。</p> <p>假设你想生成一个名为 <code>test</code> 的插件模板，请在项目的根目录下运行如下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>python vendor/plugin_generator.py -n <span class="token builtin class-name">test</span>
</code></pre></div><p>由于插件本身就是一个微型的 app，插件的开发规范与项目的开发规范几乎一致，如果你还
不够熟悉，那么请你再次阅读<a href="/lin-cms-doc/plugins/server/">开发规范</a>。</p> <p>当然，插件这里也有一个自己独特的机制——加载。在前面，我们在介绍项目开发时，红图以
及模型都是我们主动去通过<code>import</code>导入的。但是在插件中，我们可以不用做这件事情，因
为 Lin 会自动通过 loader（加载器）来帮我们做这件事，loader 可以帮我们自动去加载
插件中的红图 api 和数据模型类。</p> <p>但是，在你开发的插件中，你必须明确告诉 loader，因为 loader 真的不够聪明，它到底
该加载哪些东西。而<code>poem/app/__init__.py</code>这个文件则扮演这个角色，它里面的代码很简
单，如下：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> <span class="token punctuation">.</span>controller <span class="token keyword">import</span> api
<span class="token keyword">from</span> <span class="token punctuation">.</span>model <span class="token keyword">import</span> Poem

<span class="token keyword">def</span> <span class="token function">initial_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>在代码的第一行，我们从当前目录中的<code>controller</code>导入了<code>api</code>这个红图，第二行
从<code>model</code>中导入了<code>Poem</code>这个模型类。而后，loader 会自动的从<code>__init__.py</code>文件得到
刚才导出的<code>api</code>和<code>Poem</code>，然后存储到自身的容器中。</p> <p>当然，在<code>__init__.py</code>你可以导入多个的红图和模型，如你还可能需要加载另外一个红
图<code>some_api</code>和另外一个模型<code>Some</code>，接下来你应该在上段的代码中加入：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> <span class="token punctuation">.</span>some <span class="token keyword">import</span> some_api
<span class="token keyword">from</span> <span class="token punctuation">.</span>model <span class="token keyword">import</span> Some
</code></pre></div><p>被 loader 加载红图会被直接挂载到默认的 plugin 蓝图中，你可通过相应的 url 直接访
问。而加载的模型你可通过如下的方式得到：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lin<span class="token punctuation">.</span>core <span class="token keyword">import</span> manager <span class="token comment"># 得到manager</span>
Image <span class="token operator">=</span> manager<span class="token punctuation">.</span>get_model<span class="token punctuation">(</span><span class="token string">'Poem'</span><span class="token punctuation">)</span> <span class="token comment"># 得到加载到容器中的Log模型</span>
</code></pre></div><p>当然如果你不喜欢这种方式，你也可以通过<code>import</code>方式得到这个模型：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lin<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>poem<span class="token punctuation">.</span>app<span class="token punctuation">.</span>model <span class="token keyword">import</span> Poem
</code></pre></div><p>除了导出插件中的红图 api 和数据模型类的功能，<code>__init__.py</code>中还可以定义一个名称
为<code>initial_data</code>的函数，当插件初始化时，我们有时候需要向数据库添加一些初始数据，
其业务逻辑可以封装在这个函数中。</p> <p><code>initial_data</code>函数的编写方法非常简单，你可以查看<code>poem/app/__init__.py</code>的源码来学
习如何向数据添加初始数据。当然，如果你自己编写的插件不需要初始数据，可以不定义这
个函数。但注意，<code>__init__.py</code>文件中只处理上述的两种业务，<em>请不要在该文件下编写任
何其他的业务逻辑</em>。</p> <h2 id="插件的加载"><a href="#插件的加载" class="header-anchor">#</a> 插件的加载</h2> <p>在<a href="/lin-cms-doc/plugins/server/run_process.html">运行流程</a>一节中我们留下了一个悬念，那就是插件的加载
流程。在 Lin 源代码中，可以在 Manager 的构造函数中找到如下代码段：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span>loader <span class="token keyword">import</span> Loader
self<span class="token punctuation">.</span>loader<span class="token punctuation">:</span> Loader <span class="token operator">=</span> Loader<span class="token punctuation">(</span>plugin_path<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>这里初始化的 loader （插件加载器），由它来负责所有插件的加载，我们继续打开
Loader 的构造函数。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> plugin_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">assert</span> <span class="token builtin">type</span><span class="token punctuation">(</span>plugin_path<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> <span class="token string">'plugin_path must be a dict'</span>
    self<span class="token punctuation">.</span>plugin_path <span class="token operator">=</span> plugin_path
    self<span class="token punctuation">.</span>load_plugins_config<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 加载插件配置</span>
    self<span class="token punctuation">.</span>load_plugins<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 加载插件</span>
</code></pre></div><p>这里大致的流程是这样的，loader 率先从主 app 中读取插件的路径和配置（setting.py
文件中），然后加载每个插件单独的配置，最后加载插件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">|</span>--------------<span class="token operator">|</span>           <span class="token operator">|</span>-------------------<span class="token operator">|</span>              <span class="token operator">|</span>----------<span class="token operator">|</span>
<span class="token operator">|</span> 加载插件配置   <span class="token operator">|</span>   ----<span class="token operator">&gt;</span>   <span class="token operator">|</span>  加载插件各自配置    <span class="token operator">|</span>     ----<span class="token operator">&gt;</span>    <span class="token operator">|</span> 加载插件  <span class="token operator">|</span>
<span class="token operator">|</span>--------------<span class="token operator">|</span>           <span class="token operator">|</span>-------------------<span class="token operator">|</span>              <span class="token operator">|</span>----------<span class="token operator">|</span>
</code></pre></div><p>接下来我们继续，在 Loader 类中还有两个方法<code>_load_plugin</code>和<code>_load_config</code>，这两个
方法是 loader 的核心方法，由它们向容器中加载插件和插件配置。这两个方法的思路很明
确，我们相信你完全可以自己理解。</p> <p>好，插件的整体流程的梳理到此已经结束了。如果你感到疑惑，请记住 loader 的加载本身
只是一个很简单的过程，当你亲身通过断点 Debug 的方式去运行程序时，你就会觉得豁然
开朗。</p> <h2 id="实操-poem-插件"><a href="#实操-poem-插件" class="header-anchor">#</a> 实操 Poem 插件</h2> <blockquote><p>在大家已经了解了插件机制和插件的使用方法后，下面我们来手把手带着大家来实操的古
诗词插件，你将学到一个插件的整个开发流程和注意事项。好了，话不多说，我们开始吧
！</p></blockquote> <h3 id="主配置文件解析"><a href="#主配置文件解析" class="header-anchor">#</a> 主配置文件解析</h3> <p>打开<code>app/config/setting.py</code>文件，如果该文件中已经存在了如下配置：</p> <div class="language-py extra-class"><pre class="language-py"><code>PLUGIN_PATH <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'poem'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'path'</span><span class="token punctuation">:</span> <span class="token string">'app.plugins.poem'</span><span class="token punctuation">,</span> <span class="token string">'enable'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'limit'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>证明你已经下载插件源码并且在项目中进行了插件的初始化，上述配置会被自动写入。如果
你想了解插件初始化脚本的执行流程，请查看<code>vendor/plugin_init.py</code>的文档注释。</p> <p>如果你是自己开发插件，为了让插件的路由成功注册，以方便在开发中调试插件的 api，你
可以先手动将插件的配置写入到<code>setting.py</code>文件中。</p> <p>下面我们解释这个配置项：</p> <ul><li>PLUGIN_PATH：每个插件的单独配置。如<code>poem</code>代表当前的插件的名字
为<strong>poem</strong>，<code>path</code>表示插件的路径，如 poem 插件的路径在<code>app/plugins/poem</code>下
，<code>enable: True</code>表示开启当前插件。其他更多的配置项如 <code>limit</code> 是插件中使用到的
配置。</li></ul> <h3 id="调用获取古诗词接口"><a href="#调用获取古诗词接口" class="header-anchor">#</a> 调用获取古诗词接口</h3> <p>我们运行<code>starter.py</code>文件，然后请打开 postman 测试工具，选择 get 方法，请求 url
为<code>http://localhost:5000/plugin/poem/all</code>。</p> <p>你可能会有所疑惑？这个 url 是如何确定的，插件中的路由 url 满足下述规范。</p> <ul><li>所有插件的路由都会被挂载到 plugin 的蓝图中，该蓝图的路径前缀为<code>/plugin</code>。</li> <li>每个单独的插件都会有一个名字，如 poem 插件的名称为<code>poem</code>，若在该插件下，存在多
个红图实例（redprint）,则其所有路由都会有一个二级前缀<code>/poem</code>。若该插件下只存在
一个红图实例，即一个 controller，则不会有二级前缀，你的路径只有一个一级前缀，
即<code>/plugin</code>。</li> <li>后面的路径就被每个插件下的红图所确定，如 poem 插件下有个名为<code>poem</code>红图实例，该
红图下有<code>get_list</code>这个视图函数。此时该插件只有一个红图实例，故它的前缀只有一级
，所以获取古诗词接口的 url 为<code>/plugin/poem/all</code>。如果 all 插件下有多个红图实例
，且某个红图名为<code>some</code>，some 下有<code>test</code>的视图函数，则访问这个视图函数的 url
为<code>/plugin/poem/some/test</code>。</li></ul> <p>点击<code>Send</code>，如果一些顺利你会看到如下返回结果：</p> <div class="imgWrapper" data-v-347678d1><img src="http://imglf4.nosdn0.126.net/img/L1FxUmNhYXM3L2RnZnhXR0grZFJTZlg3RFJkRnU1UitnT3ppYmZNWlpnblFzYXI0ZktGY3dRPT0.png?imageView&amp;thumbnail=1680x0&amp;quality=96&amp;stripmeta=0" data-v-347678d1></div> <h3 id="插件局部配置文件"><a href="#插件局部配置文件" class="header-anchor">#</a> 插件局部配置文件</h3> <p>在<code>poem</code>的模型层<code>poem/app/model.py</code>代码中，你或许已经发现，我们从 lin 的核心库中
导入了<code>lin_config</code>，并且使用<code>lin_config.get_config('poem.limit')</code>获取到了配置，
那么配置文件定义在哪里呢？我们打开<code>poem/config.py</code>配置文件，可以发现，Lin 建议用
户定义的配置项是小写的。如果你开发的插件有更多的配置，都可以在这个文件中添加。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># app/plugins/poem/config.py</span>
limit <span class="token operator">=</span> <span class="token number">20</span>
</code></pre></div><p>此处设置了 limit 为 20，由于我们在 <code>setting.py</code> 中也有<strong>limit</strong>的相关配置
，<code>lin_config</code>会优先调用 setting.py 中的配置。修改<code>setting.py</code>中的 limit 为 5，
再次调用接口，可发现接口返回了 5 条古诗词的记录。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>在本小节，我们通过 poem 这个插件示例，学习了插件的开发规范和加载流程，请
在<code>controller.py</code>文件中查看相应的 api。</p> <p>我们还通过修改配置来限制获取古诗词的数量，请注意配置很重要，真的很重要，它给了插
件很大的灵活性。</p> <p>但是，在此你可能会疑惑，插件的配置与 Flask 的配置有何区别？为何我们还需要一个插
件的配置，而不是直接从 Flask 中读取。</p> <p>原因有如下几点:</p> <ul><li><p>Flask 的配置依赖 Flask 的上下文。在 Flask 中读取配置，你必须在 Flask 的上下文
中才能读取到相应的配置，而我们的插件是通过路径加载的，它的加载先于 Flask 的上
下文创建，因此很多配置只能在视图函数中使用，这不够灵活。</p></li> <li><p>插件的配置既可以在 config.py 中配置，也可以在 setting.py 中更改，Flask 本身的
配置机制不能够满足如此需求。</p></li> <li><p>再者，Flask 的配置有明确的要求，所有字母均要求大写，但很多时候如<code>poem</code>名称，我
们还是觉得小写比较直观，而且我们必须让取配置更加方便，
如<code>lin_config.get_config('poem.limit')</code>可直接取到 poem 下的 limit 配置。很多时
候插件的配置是层叠的，我们支持二级直接取配置。</p></li></ul> <p>插件的实战到这里就结束了，你可能觉得会有些短，有些少。但是这确实是真实的情况，因
为插件本身就很简单，你完全可以把它理解为一个<strong>微 app</strong>。按照我们之前的开发规范来
开发插件即可。 <div data-v-244f5c7a><ul class="rightMenuWrapper" data-v-244f5c7a></ul></div></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/TaleLin/lin-cms-doc/edit/master/docs/plugins/koa/be_develop.md" target="_blank" rel="noopener noreferrer">纠正错误</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/13/2020, 8:53:30 AM</span></div></footer> <!----> <img src="/lin-cms-doc/assets/img/bottom-logo.385a53c5.png" style="position:absolute;width:135px;left:calc(100% / 2 + 50px);transform:translateX(-50%);"></main></div><div class="global-ui"></div></div>
    <script src="/lin-cms-doc/assets/js/app.569b92f7.js" defer></script><script src="/lin-cms-doc/assets/js/9.dfe2ee52.js" defer></script><script src="/lin-cms-doc/assets/js/2.9a39114c.js" defer></script><script src="/lin-cms-doc/assets/js/47.7ebbd042.js" defer></script><script src="/lin-cms-doc/assets/js/4.8535a4ee.js" defer></script><script src="/lin-cms-doc/assets/js/6.a174ce70.js" defer></script><script src="/lin-cms-doc/assets/js/5.1de948cb.js" defer></script>
  </body>
</html>
